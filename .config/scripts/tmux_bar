#!/usr/bin/env bash

tmux_bar() {
### Corona Virus
corona=$(wget -qO- "https://corona-stats.online" \
	| sed '/Brazil/!d;s/│/\n/g;s/ //g;s/║//g' \
	| sed '1s/^/ ┃ \(Rank: /;3s/^/\) 😷 /;5s/^/ 💀 /;7s/^/ 😄 /' \
	| sed '/ /!d' \
	| sed ':a;$!N;s/\n//;ta;')
################

### Update Package
update=$(aptitude show ~U | sed '/Pacote:/!d' | wc -l)
##################

### Coins
lbc=$(wget -qO- "brl.rate.sx/lbc" \
	| grep median \
	| grep -Eo '.\...' \
	| sed -e '2!d' -e 's/^/ ┃ 📚 /')

dollar=$(wget -qO- "https://dolarhoje.com" \
        | grep "value=\"" \
	| sed "s/^.*value=\"//;s/\"\/><.*$//;s/^/ ┃ 💸 /")
#########

### Internet
internet=$(sed -e '/up\|down/!d' -e 's/down/ ┃ ❎/;s/up/ ┃ 🌐/' /sys/class/net/*/operstate \
	| sed ':a;$!N;s/\n/ /;ta;')
############

### Manga Update
file=~/Update\ Mangas\ History.md
date=$(date '+%d/%m/%Y')

[ ! -f "$file" ] \
&& echo -e " | Data | Titulo | Url |\n |:-----------:|:-----------:|:--------:|" >> "$file"
 
NManga=$(grep -c "$date" "$file")
################

### Transmission
torrent=$(stig ls \
	| awk '{print $7" "$9}' \
	| sort \
	| sed 's/.*100.*/✅/g;s/.*stopped.*/🔴/g;s/.*seeding.*/🌱/g;s/.*connected.*\|.*idle.*\|.*discovering.*/⌛️/g;s/.*uploading.*/🔼/g;s/.*downloading/🔽[/g;s/\..*$/%]/' \
	| uniq -c \
	| sed 's/ //g' \
	| sed ':a;$!N;s/\n/ /;ta;' \
	| sed 's/^/ ┃ /')
################

####### Exec #######
[ "$update" = 0 ] && echo -n "" || echo -n " ┃ 📦 Updates: $update"
[ "$NManga" = 0 ] && echo -n "" || echo -n " ┃ Manga: $NManga"
echo -n "$torrent"
echo -n "$corona"
echo -n "$dollar$lbc"
echo -n "$internet"
####################
}

####### Atualiza a Cada Minuto #######
if [ "$(date -r /tmp/tmux_bar +%M)" = "$(date '+%M')" ]; then
        cat /tmp/tmux_bar 
else
        tmux_bar > /tmp/tmux_bar && cat /tmp/tmux_bar
fi
######################################
